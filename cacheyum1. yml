Voici les 2 fichiers complets corrigés (version “safe + idempotent + rapide”), et la root cause prête à partager sur Teams.
✅ Root cause (à partager sur Teams)
FR (court)
Root cause: notre rôle conditionnait le nettoyage de /etc/fstab pour /var/cache/yum au fait que le répertoire /var/cache/yum existe (stat.exists).
Sur RHEL8/9, le dossier peut ne plus exister (dnf remplace yum) alors que l’entrée fstab est toujours présente (héritage image/kickstart/upgrade).
Donc le bloc “cleanup yum” ne s’exécutait pas, et l’entrée /var/cache/yum restait dans /etc/fstab.
EN (court)
Root cause: fstab cleanup for /var/cache/yum was wrongly gated by directory existence (stat.exists).
On RHEL8/9 the directory may not exist anymore while the legacy fstab entry still exists, so the cleanup block was skipped and the stale /var/cache/yum line remained.
1) tasks/cleanup.yml (corrigé)
Objectif : purger proprement /var/cache/yum et /var/cache/dnf (umount + fstab + dossier) sans dépendre de l’existence du répertoire.
Et sur RHEL8+, on force la suppression de yum (on ne garde que dnf ensuite via le mount final du rôle).
Yaml
Copy code
---
# tasks/cleanup.yml

- name: "Build mountpoints to cleanup"
  ansible.builtin.set_fact:
    _cache_mountpoints_cleanup: >-
      {{
        (
          ['/var/cache/dnf'] +
          (['/var/cache/yum'] if (ansible_facts['distribution_major_version'] | int) >= 8 else [])
        ) | unique
      }}

# 1) Unmount (best effort)
- name: "Unmount legacy cache mountpoints (best effort)"
  ansible.posix.mount:
    path: "{{ item }}"
    state: unmounted
  loop: "{{ _cache_mountpoints_cleanup }}"
  failed_when: false

# 2) Remove from fstab (best effort)
- name: "Remove legacy cache mountpoints from /etc/fstab (best effort)"
  ansible.posix.mount:
    path: "{{ item }}"
    state: absent
  loop: "{{ _cache_mountpoints_cleanup }}"
  failed_when: false
  notify: "Reload /etc/fstab"

# 3) Hard-remove any remaining fstab lines (bulletproof)
- name: "Hard-remove any remaining fstab lines for legacy cache mountpoints"
  ansible.builtin.lineinfile:
    path: /etc/fstab
    state: absent
    regexp: "^[[:space:]]*[^#]+[[:space:]]+{{ item | regex_escape() }}[[:space:]]+"
  loop: "{{ _cache_mountpoints_cleanup }}"
  notify: "Reload /etc/fstab"

# 4) Remove directories (cleanup)
- name: "Remove legacy cache directories (cleanup)"
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: "{{ _cache_mountpoints_cleanup }}"
  failed_when: false

# 5) Purge old/invalid LVs if requested (existing logic kept)
- name: "Purge LVs (if configured)"
  ansible.builtin.include_tasks:
    file: "cleanup/remove_lv.yml"
  loop: "{{ satellite_var_cache_yumdnf__purge_lvs | default([]) }}"
  loop_control:
    loop_var: lv_name
  when: (satellite_var_cache_yumdnf__purge_lvs | default([])) | length > 0
2) tasks/main.yml (corrigé)
Améliorations :
on garde ta logique RHEL7 vs RHEL8+ pour choisir le target (cache_mount / cache_lv)
on appelle cleanup.yml qui purge proprement l’existant
on crée le répertoire du mount cible avant mount (évite les surprises)
on garantit que sur RHEL8/9 il ne restera que /var/cache/dnf au final
Yaml
Copy code
---
# tasks/main.yml

# ------------------------------------------------------------
# 0) Init base vars with safe defaults
# ------------------------------------------------------------

- name: "Preliminary checks"
  ansible.builtin.include_tasks: "checks.yml"

# RHEL 7 -> YUM
- name: "Set cache vars for RHEL 7 (YUM)"
  ansible.builtin.set_fact:
    cache_lv: "{{ cache_lv_rhel7 | default('var_cache_yum') }}"
    cache_mount: "{{ cache_mount_rhel7 | default('/var/cache/yum') }}"
  when: ansible_facts['distribution_major_version'] | int == 7

# RHEL 8+ -> DNF
- name: "Set cache vars for RHEL 8+ (DNF)"
  ansible.builtin.set_fact:
    cache_lv: "{{ cache_lv_rhel8plus | default('var_cache_dnf') }}"
    cache_mount: "{{ cache_mount_rhel8plus | default('/var/cache/dnf') }}"
  when: ansible_facts['distribution_major_version'] | int >= 8

# ------------------------------------------------------------
# 1) Clean cache remnants (fstab/mountpoints/dirs) safely
# ------------------------------------------------------------

- name: "Cleanup the YUM/DNF cache remnants"
  ansible.builtin.include_tasks: "cleanup.yml"

# Ensure the final target is unmounted (best effort)
- name: "Ensure final target is unmounted {{ cache_mount }}"
  ansible.posix.mount:
    path: "{{ cache_mount }}"
    state: unmounted
  failed_when: false

# ------------------------------------------------------------
# 2) Create/resize LV/FS (existing logic)
# ------------------------------------------------------------

- name: "Re-create or resize the LV and mkfs"
  ansible.builtin.include_tasks: "lvfs.yml"

# Ensure mountpoint exists before mounting
- name: "Ensure cache mountpoint exists {{ cache_mount }}"
  ansible.builtin.file:
    path: "{{ cache_mount }}"
    state: directory
    mode: "0755"

# ------------------------------------------------------------
# 3) Mount target LV (mapper path) and rebuild package manager cache
# ------------------------------------------------------------

- name: "Mount cache LV (using mapper path) on {{ cache_mount }}"
  ansible.posix.mount:
    path: "{{ cache_mount }}"
    src: "/dev/mapper/{{ cache_vg }}-{{ cache_lv }}"
    fstype: "{{ cache_fstype }}"
    opts: "defaults,noexec,nosuid,nodev"
    dump: 0
    passno: 0
    state: mounted
  notify: "Reload /etc/fstab"

# ------------------------------------------------------------
# 4) DF summary
# ------------------------------------------------------------

- name: "Show df -hPT /var"
  ansible.builtin.command: "df -hPT /var"
  register: df_var
  changed_when: false
  failed_when: false

- name: "Display df for /var"
  ansible.builtin.debug:
    msg: "{{ df_var.stdout }}"

- name: "Show df -hPT for cache mount {{ cache_mount }}"
  ansible.builtin.command: "df -hPT {{ cache_mount }}"
  register: df_cache
  changed_when: false
  failed_when: false

- name: "Display DF for cache mount {{ cache_mount }}"
  ansible.builtin.debug:
    msg: "{{ df_cache.stdout }}"
Ce que ça garantit maintenant
Sur RHEL8/9 : /etc/fstab ne gardera pas /var/cache/yum (même si le dossier n’existe plus).
Le rôle est idempotent : relancer 10 fois = même résultat.
Le nettoyage est robuste : même si fstab a des lignes “bizarres”, lineinfile finit le travail.
Si tu veux, envoie-moi aussi defaults/main.yml et lvfs.yml (texte) : je peux te proposer un refactor ultra propre pour éviter les noms LV “yumcache/var_cache_yum/…” et ne purger que ce qui n’est pas le LV cible.