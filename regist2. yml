- name: subscription
  block:

    - name: "RHSM | Register (safe, NO shell, single call)"
      ansible.builtin.command:
        argv:
          - subscription-manager
          - register
          - --activationkey
          - "{{ satellite_register_ak | trim }}"
          - --org
          - "{{ satellite_register_org | trim }}"
          - "{{ (satellite_register_force | default(false)) | ternary('--force', omit) }}"
      register: rhsm_register
      changed_when: false
      failed_when: rhsm_register.rc != 0
      timeout: 300

  rescue:

    - name: "RHSM | Detect duplicate UUID error (422 / DMI UUID)"
      ansible.builtin.set_fact:
        rhsm_duplicate_uuid: >-
          {{
            (rhsm_register is defined) and
            (
              (rhsm_register.stderr | default('')) is search('HTTP error \\(422', ignorecase=True) or
              (rhsm_register.stderr | default('')) is search('Unprocessable Entity', ignorecase=True) or
              (rhsm_register.stderr | default('')) is search('DMI UUID', ignorecase=True) or
              (rhsm_register.stderr | default('')) is search('matches other registered hosts', ignorecase=True)
            )
          }}

    - name: "RHSM | Fail fast if not duplicate-UUID case"
      ansible.builtin.fail:
        msg: |
          RHSM register failed (not a duplicate UUID case).
          rc={{ rhsm_register.rc | default('N/A') }}
          stderr={{ rhsm_register.stderr | default('') }}
      when: not rhsm_duplicate_uuid

    # --- KB: remove cloned RHSM cached facts ---
    - name: "RHSM | Remove cloned facts cache (facts.json)"
      ansible.builtin.file:
        path: /var/lib/rhsm/facts/facts.json
        state: absent

    - name: "RHSM | Ensure RHSM facts dirs exist"
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - /etc/rhsm/facts
        - /var/lib/rhsm/facts

    # --- Idempotent: keep existing uuid.facts if already present ---
    - name: "RHSM | Stat uuid.facts"
      ansible.builtin.stat:
        path: /etc/rhsm/facts/uuid.facts
      register: uuid_fact_stat

    - name: "RHSM | Read existing uuid.facts (if present)"
      ansible.builtin.slurp:
        src: /etc/rhsm/facts/uuid.facts
      register: existing_uuid_fact
      when: uuid_fact_stat.stat.exists

    - name: "RHSM | Generate new UUID only if uuid.facts missing"
      ansible.builtin.command: uuidgen
      register: new_uuid
      changed_when: false
      when: not uuid_fact_stat.stat.exists

    - name: "RHSM | Set final logical UUID (stable)"
      ansible.builtin.set_fact:
        rhsm_logical_uuid: >-
          {{
            (new_uuid.stdout | trim)
            if (not uuid_fact_stat.stat.exists)
            else
            (
              (existing_uuid_fact.content | b64decode) | from_json
            )['dmi.system.uuid']
          }}

    - name: "RHSM | Write /etc/rhsm/facts/uuid.facts (custom dmi.system.uuid)"
      ansible.builtin.copy:
        dest: /etc/rhsm/facts/uuid.facts
        owner: root
        group: root
        mode: "0644"
        content: |
          {"dmi.system.uuid":"{{ rhsm_logical_uuid }}"}

    # Optional audit file (nice for troubleshooting)
    - name: "RHSM | Store logical UUID for audit"
      ansible.builtin.copy:
        dest: /etc/rhsm_logical_uuid
        owner: root
        group: root
        mode: "0644"
        content: "{{ rhsm_logical_uuid }}\n"

    - name: "RHSM | Update facts to apply custom UUID"
      ansible.builtin.command: subscription-manager facts --update
      register: facts_update
      changed_when: false
      failed_when: false

    - name: "RHSM | Retry register after KB fix"
      ansible.builtin.command:
        argv:
          - subscription-manager
          - register
          - --activationkey
          - "{{ satellite_register_ak | trim }}"
          - --org
          - "{{ satellite_register_org | trim }}"
          - --force
      register: rhsm_register_retry
      changed_when: false
      failed_when: rhsm_register_retry.rc != 0
      timeout: 300

  always:

    - name: "RHSM | Debug (main + retry)"
      ansible.builtin.debug:
        msg:
          - "MAIN rc={{ rhsm_register.rc | default('N/A') }} stderr={{ rhsm_register.stderr | default('') }}"
          - "LOGICAL_UUID={{ rhsm_logical_uuid | default('N/A') }}"
          - "RETRY rc={{ rhsm_register_retry.rc | default('N/A') }} stderr={{ rhsm_register_retry.stderr | default('') }}"
      verbosity: 1

    # Hard fail message if still failing after retry
    - name: "RHSM | Fail clearly if retry still failed (action required)"
      ansible.builtin.fail:
        msg: |
          RHSM registration still failing after applying KB fix (custom dmi.system.uuid + facts cache cleanup).
          - Logical UUID used: {{ rhsm_logical_uuid | default('N/A') }}
          - Initial stderr: {{ rhsm_register.stderr | default('') }}
          - Retry stderr: {{ rhsm_register_retry.stderr | default('') }}

          Next actions:
          1) Check Satellite setting:
             Administer -> Settings -> Content -> 'Host Duplicate DMI UUIDs'
             Add/allow the UUID as per policy (array format), OR
          2) Regenerate BIOS/DMI UUID at hypervisor/provisioning layer (Terraform/VMware template issue).
      when:
        - rhsm_register_retry is defined
        - rhsm_register_retry.rc is defined
        - rhsm_register_retry.rc != 0