Oui ✅ c’est possible de corriger ça en ne touchant qu’aux templates Jinja.
Pourquoi ton job met TCP 443 OK: False alors que nc dit Connected ?
Parce que ton template tcp_ok.j2 (ou la logique actuelle) ne considère pas “Connected to …:443” comme un succès, ou bien il ne se base pas sur le bon champ (rc vs parsing de stdout/stderr).
Avec ncat, le message “Connected to …:443” peut sortir sur stdout/stderr selon version, mais le plus fiable reste :
rc == 0 OU
présence de “Connected to …:443” dans stdout/stderr
Et tu veux aussi : si l’un des checks (nc OU telnet OU /dev/tcp) est OK → port_443_ok = true.
✅ Solution : remplacer uniquement 4 templates
Tu gardes ton tasks/main.yml tel quel, et tu modifies seulement :
templates/tcp_ok.j2
templates/tcp_method.j2
templates/tcp_rc.j2
templates/tcp_err.j2
⚠️ Ces templates supposent que tes tasks enregistrent bien : _tcp_nc, _tcp_telnet, _tcp_devtcp (comme dans tes screenshots).
Si tu as un nom différent (ex: _tcp_devtcp vs _tcp_dev_tcp), dis-moi et je t’adapte.
✅ templates/tcp_ok.j2
Objectif : true si au moins un des checks est OK.
Copy code
Jinja2
{# Returns 'true' if ANY TCP 443 check is OK (nc OR telnet OR /dev/tcp). #}

{# Helper booleans #}
{% set nc_defined = (_tcp_nc is defined) %}
{% set telnet_defined = (_tcp_telnet is defined) %}
{% set devtcp_defined = (_tcp_devtcp is defined) %}

{% set nc_rc_ok = (nc_defined and ((_tcp_nc.rc | default(1)) == 0)) %}
{% set telnet_rc_ok = (telnet_defined and ((_tcp_telnet.rc | default(1)) == 0)) %}
{% set devtcp_rc_ok = (devtcp_defined and ((_tcp_devtcp.rc | default(1)) == 0)) %}

{# Some tools print success keywords even if parsing is needed #}
{% set nc_out = ( (_tcp_nc.stdout | default('')) ~ ' ' ~ (_tcp_nc.stderr | default('')) ) if nc_defined else '' %}
{% set telnet_out = ( (_tcp_telnet.stdout | default('')) ~ ' ' ~ (_tcp_telnet.stderr | default('')) ) if telnet_defined else '' %}
{% set devtcp_out = ( (_tcp_devtcp.stdout | default('')) ~ ' ' ~ (_tcp_devtcp.stderr | default('')) ) if devtcp_defined else '' %}

{% set nc_msg_ok = (nc_defined and (('Connected to' in nc_out) or ('succeeded' in nc_out) or ('open' in nc_out))) %}
{% set telnet_msg_ok = (telnet_defined and (('Escape character' in telnet_out) or ('Connected to' in telnet_out))) %}
{% set devtcp_msg_ok = (devtcp_defined and (('succeeded' in devtcp_out) or ('open' in devtcp_out))) %}

{% if nc_rc_ok or telnet_rc_ok or devtcp_rc_ok or nc_msg_ok or telnet_msg_ok or devtcp_msg_ok %}
true
{% else %}
false
{% endif %}
✅ templates/tcp_method.j2
Objectif : retourner la méthode gagnante (celle qui est OK).
Copy code
Jinja2
{# Returns which method proved TCP 443 is OK: nc/telnet/devtcp/none #}

{% set ok = (lookup('template', 'tcp_ok.j2') | trim) %}
{% if ok != 'true' %}
none
{% else %}
  {% if _tcp_nc is defined %}
    {% set nc_out = (_tcp_nc.stdout | default('')) ~ ' ' ~ (_tcp_nc.stderr | default('')) %}
    {% if (_tcp_nc.rc | default(1)) == 0 or ('Connected to' in nc_out) or ('succeeded' in nc_out) or ('open' in nc_out) %}
nc
    {% else %}
      {% if _tcp_telnet is defined %}
        {% set t_out = (_tcp_telnet.stdout | default('')) ~ ' ' ~ (_tcp_telnet.stderr | default('')) %}
        {% if (_tcp_telnet.rc | default(1)) == 0 or ('Escape character' in t_out) or ('Connected to' in t_out) %}
telnet
        {% else %}
          {% if _tcp_devtcp is defined and (_tcp_devtcp.rc | default(1)) == 0 %}
devtcp
          {% else %}
none
          {% endif %}
        {% endif %}
      {% elif _tcp_devtcp is defined and (_tcp_devtcp.rc | default(1)) == 0 %}
devtcp
      {% else %}
none
      {% endif %}
    {% endif %}
  {% elif _tcp_telnet is defined %}
    {% set t_out = (_tcp_telnet.stdout | default('')) ~ ' ' ~ (_tcp_telnet.stderr | default('')) %}
    {% if (_tcp_telnet.rc | default(1)) == 0 or ('Escape character' in t_out) or ('Connected to' in t_out) %}
telnet
    {% elif _tcp_devtcp is defined and (_tcp_devtcp.rc | default(1)) == 0 %}
devtcp
    {% else %}
none
    {% endif %}
  {% elif _tcp_devtcp is defined and (_tcp_devtcp.rc | default(1)) == 0 %}
devtcp
  {% else %}
none
  {% endif %}
{% endif %}
✅ templates/tcp_rc.j2
Objectif : rc de la méthode choisie (ou N/A).
Copy code
Jinja2
{# Returns rc of the method used (prefer the successful one). #}

{% set m = (lookup('template', 'tcp_method.j2') | trim) %}
{% if m == 'nc' and _tcp_nc is defined %}
{{ _tcp_nc.rc | default('N/A') }}
{% elif m == 'telnet' and _tcp_telnet is defined %}
{{ _tcp_telnet.rc | default('N/A') }}
{% elif m == 'devtcp' and _tcp_devtcp is defined %}
{{ _tcp_devtcp.rc | default('N/A') }}
{% else %}
N/A
{% endif %}
✅ templates/tcp_err.j2
Objectif : afficher un résumé utile (stderr sinon stdout), sur 1–2 lignes.
Copy code
Jinja2
{# Returns a compact error/info message for the chosen method. #}

{% set m = (lookup('template', 'tcp_method.j2') | trim) %}

{% if m == 'nc' and _tcp_nc is defined %}
{% set s = (_tcp_nc.stderr | default('')) | trim %}
{% set o = (_tcp_nc.stdout | default('')) | trim %}
{{ (s if s else o) }}

{% elif m == 'telnet' and _tcp_telnet is defined %}
{% set s = (_tcp_telnet.stderr | default('')) | trim %}
{% set o = (_tcp_telnet.stdout | default('')) | trim %}
{{ (s if s else o) }}

{% elif m == 'devtcp' and _tcp_devtcp is defined %}
{% set s = (_tcp_devtcp.stderr | default('')) | trim %}
{% set o = (_tcp_devtcp.stdout | default('')) | trim %}
{{ (s if s else o) }}

{% else %}
{% if _tcp_nc is defined %}
{% set s = ((_tcp_nc.stderr | default('')) ~ ' ' ~ (_tcp_nc.stdout | default(''))) | trim %}
{{ s }}
{% elif _tcp_telnet is defined %}
{% set s = ((_tcp_telnet.stderr | default('')) ~ ' ' ~ (_tcp_telnet.stdout | default(''))) | trim %}
{{ s }}
{% elif _tcp_devtcp is defined %}
{% set s = ((_tcp_devtcp.stderr | default('')) ~ ' ' ~ (_tcp_devtcp.stdout | default(''))) | trim %}
{{ s }}
{% else %}
No TCP check output
{% endif %}
{% endif %}
✅ Effet attendu chez toi (cas s02l9940977)
Tu as dans la console : Ncat: Connected to 55.18.158.142:443
➡️ Avec ce nouveau tcp_ok.j2, ça devient :
port_443_ok = true
tcp_method = nc
donc le rôle ne doit plus échouer sur ce host.
Petit check rapide à faire après commit
Relance ton job AAP et regarde dans le message :
TCP method : nc
TCP 443 OK : True
Si ça reste False malgré “Connected”, alors la variable enregistrée n’est pas _tcp_nc (autre nom) ou le texte “Connected to” est ailleurs (par ex uniquement stdout).
Dans ce cas envoie-moi juste le bloc de task nc (5 lignes) et je l’adapte exactement à ton output.
Tu veux aussi que je te fournisse une version “ultra stricte” qui se base uniquement sur rc==0 (sans parsing texte), ou tu préfères garder les deux (rc + message) ?