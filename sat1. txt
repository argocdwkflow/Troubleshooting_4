

Oui â€” dâ€™aprÃ¨s tes captures, ton rÃ´le bloque volontairement lâ€™enregistrement si la machine nâ€™est pas sur la derniÃ¨re minor (8.10 / 9.6) et si satellite_register_minor_version est vide.
Dans ton tasks/main.yml on voit un bloc du style :
Fail if minor version is not set and doesn't match latest version
msg : â€œThis host is not running latest OS minor version and you didn't set minor version variable â€¦â€
et dans defaults/main.yml tu as :
satellite_register_minor_version: ""
satellite_latest_minor: { "9":"9.6", "8":"8.10", "7":"7.9" }
Donc ton job Ã©choue â€œpar designâ€.
Objectif
âœ… Autoriser lâ€™enregistrement mÃªme si la machine est en 8.8 / 9.4
âœ… Garder la possibilitÃ© de forcer une minor (cas exceptions)
âœ… Et optionnel : construire une AK globale par majeure (sans la minor dans le nom)
Modification expert (best practice) : â€œminor optionnelleâ€
1) Ajouter un flag â€œallow any minorâ€
Dans defaults/main.yml (ou vars) :
Copy code
Yaml
satellite_register_allow_any_minor: true
# si false => on garde le comportement strict actuel
2) Remplacer le FAIL â€œlatest minor obligatoireâ€
Dans tasks/main.yml, remplace ton task â€œFail if minor version is not setâ€¦â€ par une version conditionnÃ©e :
Copy code
Yaml
- name: Set current OS minor (full release)
  ansible.builtin.set_fact:
    satellite_current_minor: "{{ ansible_distribution_version }}"

- name: Fail only if strict minor policy is enabled
  ansible.builtin.fail:
    msg: >-
      Host OS minor={{ satellite_current_minor }} does not match expected minor={{ satellite_register_minor_version }}.
      Either set satellite_register_allow_any_minor=true or define satellite_register_minor_version.
  when:
    - not (satellite_register_allow_any_minor | default(true) | bool)
    - (satellite_register_minor_version is defined)
    - (satellite_register_minor_version | length > 0)
    - satellite_current_minor != satellite_register_minor_version
ğŸ’¡ Effet :
Par dÃ©faut (allow_any_minor=true) => plus de blocage pour 8.8 / 9.4
Si tu veux un mode â€œstrictâ€ => tu mets allow_any_minor=false + satellite_register_minor_version: "9.4" par exemple
AK â€œglobaleâ€ par majeure (sans minor dans le nom)
Dans ta capture, tu construis lâ€™AK avec {{ satellite_register_minor_version }} au milieu. Tu peux faire une construction conditionnelle propre :
Copy code
Yaml
- name: Define activation key based on major/minor/env
  ansible.builtin.set_fact:
    satellite_register_ak: >-
      {% if (satellite_register_minor_version | default('') | length) > 0 %}
      RHEL{{ satellite_register_major_version }}_{{ satellite_register_minor_version }}_{{ satellite_register_arch }}_{{ satellite_register_env }}
      {% else %}
      RHEL{{ satellite_register_major_version }}_{{ satellite_register_arch }}_{{ satellite_register_env }}
      {% endif %}
  when: satellite_register_ak is not defined
âœ… RÃ©sultat :
Si satellite_register_minor_version: "" => AK = RHEL9_x86_64_PROD (globale majeure)
Si satellite_register_minor_version: "9.4" => AK = RHEL9_9.4_x86_64_PROD (cas exceptionnel)
Option bonus : â€œsi minor fournie, je la force cÃ´tÃ© clientâ€
Si tu veux que le rÃ´le force la minor au lieu dâ€™Ã©chouer :
Copy code
Yaml
- name: Force release lock when minor is specified
  ansible.builtin.command: "subscription-manager release --set={{ satellite_register_minor_version }}"
  when:
    - satellite_register_minor_version is defined
    - satellite_register_minor_version | length > 0
  changed_when: true
  failed_when: false
(Ã€ positionner avant la registration/refresh repos.)
OÃ¹ dÃ©finir la minor uniquement pour quelques serveurs ?
Exemples :
group_vars/rhel9_94.yml
Copy code
Yaml
satellite_register_minor_version: "9.4"
satellite_register_allow_any_minor: false
Sinon global par dÃ©faut
Copy code
Yaml
satellite_register_minor_version: ""
satellite_register_allow_any_minor: true
Si tu veux, colle ici le petit bout exact de ton tasks/main.yml autour des lignes du fail minor + la ligne de construction satellite_register_ak, et je te renvoie un patch prÃªt Ã  commit (diff) adaptÃ© exactement Ã  ton repo.


Parfait â€” tes captures montrent exactement oÃ¹ Ã§a bloque :
âœ… Le blocage actuel
Dans roles/satellite_register/tasks/main.yml tu as ce task :
Copy code
Yaml
- name: "Fail if minor version is not set and doesn't match latest version"
  ansible.builtin.fail:
    msg: "This host is not running latest OS minor version ..."
  when: (satellite_register_minor_version is not defined or satellite_register_minor_version == "") and
        ansible_distribution_version is version(satellite_latest_minor[satellite_register_major_version], '!=')
Donc si la machine est 9.4 et que satellite_register_minor_version est vide, et que satellite_latest_minor["9"]="9.6" â‡’ FAIL.
Modification â€œexpertâ€ (petite + propre) : rendre le check optionnel
1) Ajoute un flag dans defaults/main.yml
Tu gardes ton mapping satellite_latest_minor, mais tu ajoutes un switch :
Copy code
Yaml
# By default: accept ANY minor version at registration time
satellite_register_enforce_latest_minor: false

# optional: keep this empty for "global AK" by major
satellite_register_minor_version: ""
2) Modifie le task FAIL pour quâ€™il ne sâ€™applique que si on lâ€™active
Remplace ton when: par ceci :
Copy code
Yaml
- name: "Fail if minor version is not set and doesn't match latest version"
  ansible.builtin.fail:
    msg: >-
      This host is not running latest OS minor version (current={{ ansible_distribution_version }},
      latest={{ satellite_latest_minor[satellite_register_major_version|string] }}).
      Set satellite_register_minor_version to keep a specific minor OR disable enforce via
      satellite_register_enforce_latest_minor=false.
  when:
    - satellite_register_enforce_latest_minor | default(false) | bool
    - (satellite_register_minor_version is not defined) or (satellite_register_minor_version | length == 0)
    - ansible_distribution_version is version(satellite_latest_minor[satellite_register_major_version|string], '!=')
âœ… RÃ©sultat :
Par dÃ©faut (false) => 9.4 / 8.8 passent (enregistrement OK)
Si un jour tu veux â€œforcer latestâ€ => tu mets satellite_register_enforce_latest_minor: true dans le job template / group_vars.
Bonus important : ton Activation Key contient la minor â†’ Ã  rendre â€œglobaleâ€
Dans ta capture tu construis lâ€™AK comme Ã§a (minor collÃ©e dans le nom) :
Copy code
Yaml
satellite_register_ak: "RHEL{{ satellite_register_major_version }}{{ satellite_register_minor_version }}-{{ satellite_register_arch }}-{{ satellite_register_env }}"
Si tu veux AK globale par majeure, fais une construction conditionnelle :
Copy code
Yaml
- name: "Define activation key based on distribution and environment if not supplied"
  ansible.builtin.set_fact:
    satellite_register_ak: >-
      {% if (satellite_register_minor_version | default('') | length) > 0 %}
      RHEL{{ satellite_register_major_version }}{{ satellite_register_minor_version }}-{{ satellite_register_arch }}-{{ satellite_register_env }}
      {% else %}
      RHEL{{ satellite_register_major_version }}-{{ satellite_register_arch }}-{{ satellite_register_env }}
      {% endif %}
  when: satellite_register_ak is not defined
âœ… Exemple :
minor vide â‡’ RHEL9-x86_64-PROD
minor = 9.4 â‡’ RHEL99.4-x86_64-PROD (si tu veux garder ce format)
(si tu prÃ©fÃ¨res un format plus clean: RHEL9_9.4-... au lieu de RHEL99.4-..., je te le mets aussi)
Option â€œpropreâ€ : si on spÃ©cifie une minor, on la lock cÃ´tÃ© client
AprÃ¨s le register, tu peux ajouter :
Copy code
Yaml
- name: Lock release when minor is provided
  ansible.builtin.command: "subscription-manager release --set={{ satellite_register_minor_version }}"
  when:
    - satellite_register_minor_version is defined
    - satellite_register_minor_version | length > 0
  changed_when: true
Comment lâ€™utiliser dans AAP (sans toucher le code)
Cas normal (accepter 9.4 / 8.8) : rien Ã  passer
Cas strict : extra_vars
Copy code
Yaml
satellite_register_enforce_latest_minor: true
Cas â€œje veux rester en 9.4â€ :
Copy code
Yaml
satellite_register_minor_version: "9.4"
Si tu veux, envoie-moi juste les 15 lignes exactes autour du task â€œFail if minorâ€¦â€ + le task â€œDefine activation keyâ€¦â€ (copier/coller texte), et je te renvoie un diff Git complet prÃªt Ã  commit (avec le format AK exact que tu veux).


OK â€” pour enregistrer nâ€™importe quelle minor (8.6/8.8/8.10â€¦) vers une AK globale par MAJEURE (RHEL8 ou RHEL9), tu fais 2 petites modifs dans le rÃ´le :
1) DÃ©sactiver le â€œfail si pas latest minorâ€
Dans roles/satellite_register/tasks/main.yml, commente ou garde le task mais mets une condition impossible.
Le plus propre : ajouter un flag et le laisser Ã  false par dÃ©faut.
defaults/main.yml
Copy code
Yaml
# Accept any minor at registration time
satellite_register_enforce_latest_minor: false

# empty => global AK by major
satellite_register_minor_version: ""
tasks/main.yml (ton task existant)
Copy code
Yaml
- name: "Fail if minor version is not set and doesn't match latest version"
  ansible.builtin.fail:
    msg: "This host is not running latest OS minor version ..."
  when:
    - satellite_register_enforce_latest_minor | default(false) | bool
    - (satellite_register_minor_version is not defined) or (satellite_register_minor_version | length == 0)
    - ansible_distribution_version is version(satellite_latest_minor[satellite_register_major_version|string], '!=')
âœ… Ainsi : par dÃ©faut Ã§a ne bloque plus pour 9.4 / 8.8.
2) Construire lâ€™Activation Key â€œglobaleâ€ par majeure (sans minor)
Dans tasks/main.yml, remplace ta construction dâ€™AK qui inclut satellite_register_minor_version par :
Copy code
Yaml
- name: "Define activation key based on distribution and environment if not supplied"
  ansible.builtin.set_fact:
    satellite_register_ak: "RHEL{{ satellite_register_major_version }}-{{ satellite_register_arch }}-{{ satellite_register_env }}"
  when: satellite_register_ak is not defined
âœ… RÃ©sultat :
Toute machine RHEL 8.x â‡’ RHEL8-x86_64-PROD (ou NONPRODâ€¦)
Toute machine RHEL 9.x â‡’ RHEL9-x86_64-PROD
3) CÃ´tÃ© Satellite (Ã  ne pas oublier)
Pour que Ã§a marche â€œglobalâ€, lâ€™AK ne doit pas fixer un releasever :
Activation Key â†’ Release Version : vide / Not set
Et Ã©vite de fixer â€œRelease versionâ€ au niveau Host/Hostgroup si tu veux accepter toutes les minors.
Test rapide
Relance ton job sur une machine 9.4 : il doit passer et utiliser lâ€™AK RHEL9-....
Si tu veux, donne-moi ton pattern exact de nommage AK (ex: RHEL9_PROD_x86_64 ou AK_RHEL9_PROD) et je te fournis la ligne set_fact exactement au bon format.