Oui, câ€™est possible, mais en safe prod il faut le faire de faÃ§on contrÃ´lÃ©e :
Par dÃ©faut : si dÃ©jÃ  enregistrÃ© â†’ on ne touche pas.
Si tu actives un â€œforce re-registerâ€ : alors on fait unregister + clean (+ purge) puis register Ã  nouveau.
âš ï¸ Important : --force tout seul ne garantit pas un vrai â€œresetâ€ cÃ´tÃ© client (consumer/certs/facts). Le plus fiable est : unregister + clean (+ purge certs/cache) puis register --force.
âœ… ImplÃ©mentation propre dans ton rÃ´le
1) Variables
defaults/main.yml
Copy code
Yaml
rhsm_reregister_if_already_registered: false   # safe prod default
rhsm_purge_strong_on_reregister: true         # recommandÃ©
2) DÃ©tection â€œdÃ©jÃ  enregistrÃ©â€
Copy code
Yaml
- name: RHSM | Check if already registered
  ansible.builtin.command: subscription-manager identity
  register: rhsm_identity_pre
  failed_when: false
  changed_when: false
3) DÃ©cision : doit-on re-register ?
Copy code
Yaml
- name: RHSM | Decide if we must re-register
  ansible.builtin.set_fact:
    rhsm_do_reregister: >-
      {{
        (rhsm_reregister_if_already_registered | bool)
        and
        (rhsm_identity_pre.rc == 0)
      }}
4) Si dÃ©jÃ  enregistrÃ© ET option activÃ©e â†’ cleanup + register
Copy code
Yaml
- name: RHSM | Cleanup before re-register (already registered)
  ansible.builtin.import_tasks: rhsm_cleanup_safe.yml
  when: rhsm_do_reregister | bool
  vars:
    rhsm_purge_strong_on_failure: "{{ rhsm_purge_strong_on_reregister }}"
    rhsm_remove_uuid_fact_on_failure: true
5) Register (aprÃ¨s cleanup) â€” une seule commande safe
Copy code
Yaml
- name: RHSM | Register after cleanup
  ansible.builtin.command:
    argv:
      - subscription-manager
      - register
      - "--activationkey={{ satellite_register_ak }}"
      - "--org={{ satellite_register_org }}"
      - "--force"
  register: rhsm_register_after_cleanup
  failed_when: rhsm_register_after_cleanup.rc != 0
  changed_when: "'The system has been registered' in (rhsm_register_after_cleanup.stdout | default(''))"
  when: rhsm_do_reregister | bool
6) Sinon (pas enregistrÃ©) â†’ register normal
Copy code
Yaml
- name: RHSM | Register (normal path)
  ansible.builtin.command:
    argv:
      - subscription-manager
      - register
      - "--activationkey={{ satellite_register_ak }}"
      - "--org={{ satellite_register_org }}"
      - "{{ '--force' if (satellite_register_force | default(false)) else omit }}"
  register: rhsm_register_normal
  failed_when: rhsm_register_normal.rc != 0
  changed_when: "'The system has been registered' in (rhsm_register_normal.stdout | default(''))"
  when:
    - rhsm_identity_pre.rc != 0
    - not (rhsm_do_reregister | bool)
ğŸ§  Note importante (prod)
Re-register va :
crÃ©er un nouveau consumer cÃ´tÃ© Satellite
parfois laisser un ancien content-host â€œstaleâ€ cÃ´tÃ© Satellite (selon vos settings)
ğŸ‘‰ Si vous voulez faire â€œclean completâ€ cÃ´tÃ© Satellite aussi, il faut ajouter une Ã©tape hammer (sur le control node) pour supprimer lâ€™ancien content-host avant de register.
Si tu me confirmes juste le comportement voulu :
Re-register uniquement si rhsm_reregister_if_already_registered=true âœ…
ou
Re-register toujours quand satellite_register_force=true (plus agressif)
â€¦je te donne le patch exact dans ton main.yml avec la mÃªme logique de variables que tu utilises dÃ©jÃ .