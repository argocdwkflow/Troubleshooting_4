Oui, ton intuition est bonne : ce nâ€™est pas â€œlâ€™antislashâ€, câ€™est surtout ton bloc YAML |> qui gÃ©nÃ¨re une chaÃ®ne multi-ligne avec guillemets + retour ligne â†’ au final tu te retrouves avec une AK qui contient un espace / newline (souvent Ã  la fin), donc Satellite ne la retrouve pas.
Sur ta capture, tu construis satellite_register_ak comme Ã§a :
Copy code
Yaml
satellite_register_ak: |>
  {% if ... %}
  "RHEL{{ ... }}-{{ ... }}-{{ ... }}-{{ ... }}"
  {% else %}
  "RHEL{{ ... }}-{{ ... }}-{{ ... }}"
  {% endif %}
Pourquoi Ã§a casse
Les guillemets " font partie de la valeur.
Le bloc |> (ou |) + indentation peut introduire un newline.
RÃ©sultat : lâ€™AK envoyÃ©e peut devenir : RHEL9-x86_64-PRODâ  ou RHEL9-x86_64-PROD\n â†’ 404.
âœ… Fix propre (recommandÃ©) : supprimer guillemets + supprimer multi-ligne + trim
Remplace ton set_fact par Ã§a (copier/coller) :
Copy code
Yaml
- name: "Define activation key based on distribution and environment if not supplied"
  ansible.builtin.set_fact:
    satellite_register_ak: >-
      {{
        (
          (satellite_register_minor_version | default('') | length > 0)
          | ternary(
              'RHEL' ~ satellite_register_major_version ~ '-' ~ satellite_register_minor_version ~ '-' ~ satellite_register_arch ~ '-' ~ satellite_register_env_mapping[satellite_register_env],
              'RHEL' ~ satellite_register_major_version ~ '-' ~ satellite_register_arch ~ '-' ~ satellite_register_env_mapping[satellite_register_env]
            )
        ) | trim
      }}
  when: satellite_register_ak is not defined
âœ… Avantages :
pas de guillemets dans la valeur
pas de retour Ã  la ligne
trim enlÃ¨ve espaces/newlines invisibles
âœ… Fix minimal (si tu veux garder ton bloc actuel)
Tu gardes ton set_fact mais tu â€œnettoiesâ€ juste aprÃ¨s :
Copy code
Yaml
- name: Normalize activation key (remove quotes/whitespace)
  ansible.builtin.set_fact:
    satellite_register_ak: "{{ satellite_register_ak | trim | regex_replace('^\"|\"$', '') }}"
âœ… Et sÃ©curise aussi la commande register
Dans ton argv, force trim :
Copy code
Yaml
- "--activationkey={{ satellite_register_ak | trim }}"
ğŸ” Debug 10 secondes (pour confirmer lâ€™espace)
Ajoute avant le register :
Copy code
Yaml
- debug:
    msg:
      - "AK_RAW=[{{ satellite_register_ak }}]"
      - "AK_TRIM=[{{ satellite_register_ak | trim }}]"
Si tu vois AK_RAW=[RHEL9-x86_64-PROD ] â†’ bingo.
Si tu veux, je te propose une version encore plus safe : validation que lâ€™AK existe dans Satellite via hammer avant de lancer subscription-manager register (Ã§a Ã©vite dâ€™Ã©chouer sur 500 serveurs).