---
# tasks/rhsm_uuid_422_rescue.yml

- name: "RHSM | Detect duplicate UUID error (422 / DMI UUID)"
  ansible.builtin.set_fact:
    rhsm_duplicate_uuid: >-
      {{
        (rhsm_register is defined) and
        (
          (rhsm_register.stderr | default('')) is search('HTTP error \\(422', ignorecase=True) or
          (rhsm_register.stderr | default('')) is search('Unprocessable Entity', ignorecase=True) or
          (rhsm_register.stderr | default('')) is search('DMI UUID', ignorecase=True) or
          (rhsm_register.stderr | default('')) is search('matches other registered hosts', ignorecase=True)
        )
      }}

- name: "RHSM | Fail fast if not duplicate-UUID case"
  ansible.builtin.fail:
    msg: |
      RHSM register failed (not a duplicate UUID case).
      rc={{ rhsm_register.rc | default('N/A') }}
      stderr={{ rhsm_register.stderr | default('') }}
  when: not rhsm_duplicate_uuid

- name: "RHSM | Remove cloned facts cache (facts.json)"
  ansible.builtin.file:
    path: /var/lib/rhsm/facts/facts.json
    state: absent

- name: "RHSM | Ensure RHSM facts dirs exist"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - /etc/rhsm/facts
    - /var/lib/rhsm/facts

- name: "RHSM | Stat uuid.facts"
  ansible.builtin.stat:
    path: /etc/rhsm/facts/uuid.facts
  register: uuid_fact_stat

- name: "RHSM | Read existing uuid.facts (if present)"
  ansible.builtin.slurp:
    src: /etc/rhsm/facts/uuid.facts
  register: existing_uuid_fact
  when: uuid_fact_stat.stat.exists

- name: "RHSM | Generate new UUID only if uuid.facts missing"
  ansible.builtin.command: uuidgen
  register: new_uuid
  changed_when: false
  when: not uuid_fact_stat.stat.exists

- name: "RHSM | Set final logical UUID (stable)"
  ansible.builtin.set_fact:
    rhsm_logical_uuid: >-
      {{
        (new_uuid.stdout | trim)
        if (not uuid_fact_stat.stat.exists)
        else
        (
          (existing_uuid_fact.content | b64decode) | from_json
        )['dmi.system.uuid']
      }}

- name: "RHSM | Write /etc/rhsm/facts/uuid.facts"
  ansible.builtin.copy:
    dest: /etc/rhsm/facts/uuid.facts
    owner: root
    group: root
    mode: "0644"
    content: |
      {"dmi.system.uuid":"{{ rhsm_logical_uuid }}"}

- name: "RHSM | Update facts to apply custom UUID"
  ansible.builtin.command: subscription-manager facts --update
  register: facts_update
  changed_when: false
  failed_when: false

- name: "RHSM | Retry register after KB fix"
  ansible.builtin.command:
    argv:
      - subscription-manager
      - register
      - --activationkey
      - "{{ satellite_register_ak | trim }}"
      - --org
      - "{{ satellite_register_org | trim }}"
      - --force
  register: rhsm_register_retry
  changed_when: false
  failed_when: rhsm_register_retry.rc != 0
  timeout: 300