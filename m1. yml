# ------------------------------------------------------------
# RHSM register with rescue on UUID conflict
# ------------------------------------------------------------
- name: "RHSM | Register with rescue on UUID conflict"
  block:

    - name: "RHSM | Register (first attempt)"
      ansible.builtin.command:
        argv:
          - subscription-manager
          - register
          - "--activationkey={{ satellite_register_ak }}"
          - "--org={{ satellite_register_org }}"
      register: rhsm_register_try
      failed_when: rhsm_register_try.rc != 0

  rescue:

    # --------------------------------------------------------
    # Detect UUID / duplicate conflict
    # --------------------------------------------------------
    - name: "RHSM | Detect UUID conflict"
      ansible.builtin.set_fact:
        rhsm_uuid_conflict: >-
          {{
            (rhsm_register_try.stderr | default('') is search('matches other registered hosts|duplicate|uuid|aborted', ignorecase=True))
            or
            (rhsm_register_try.stdout | default('') is search('matches other registered hosts|duplicate|uuid|aborted', ignorecase=True))
          }}

    - name: "Abort if failure is not UUID conflict"
      ansible.builtin.fail:
        msg: |
          RHSM register failed but NOT a UUID conflict.
          stdout={{ rhsm_register_try.stdout | default('') }}
          stderr={{ rhsm_register_try.stderr | default('') }}
      when: not rhsm_uuid_conflict

    # --------------------------------------------------------
    # 1) Satellite-side cleanup (hammer)
    # --------------------------------------------------------
    - name: "SATELLITE | Cleanup old registration via hammer"
      ansible.builtin.import_tasks: hammer_cleanup.yml
      when: rhsm_uuid_conflict | bool

    # --------------------------------------------------------
    # 2) Local RHSM cleanup
    # --------------------------------------------------------
    - name: "RHSM | Local cleanup"
      ansible.builtin.import_tasks: rhsm_cleanup.yml
      vars:
        satellite_register_force: true
      when: rhsm_uuid_conflict | bool

    # --------------------------------------------------------
    # 3) Retry register (force)
    # --------------------------------------------------------
    - name: "RHSM | Register retry (--force)"
      ansible.builtin.command:
        argv:
          - subscription-manager
          - register
          - "--activationkey={{ satellite_register_ak }}"
          - "--org={{ satellite_register_org }}"
          - --force
      register: rhsm_register_retry
      failed_when: rhsm_register_retry.rc != 0

# ------------------------------------------------------------
# Final verification
# ------------------------------------------------------------
- name: "RHSM | Verify identity"
  ansible.builtin.command: subscription-manager identity
  register: rhsm_identity_final
  failed_when: rhsm_identity_final.rc != 0
  changed_when: false