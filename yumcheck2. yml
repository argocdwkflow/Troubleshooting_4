---
# Precheck capsule access (TCP 443) + download kernel_version file to /tmp then cleanup

- name: Set RHEL major
  ansible.builtin.set_fact:
    sat_precheck_rhel_major: "{{ ansible_distribution_major_version | string }}"
  changed_when: false

- name: Check supported OS (RHEL 7/8/9/10)
  ansible.builtin.fail:
    msg: >-
      OS non supportÃ©: {{ ansible_distribution }} {{ ansible_distribution_version }}
      (major={{ sat_precheck_rhel_major }})
  when:
    - ansible_distribution != "RedHat"
    - sat_precheck_rhel_major not in sat_precheck_supported_majors

# IMPORTANT: split set_fact in 2 tasks (Ansible does not allow referencing new facts inside same set_fact)
- name: Build kernel file name
  ansible.builtin.set_fact:
    sat_precheck_kernel_file: >-
      {{ sat_precheck_kernel_file_prefix }}-{{ sat_precheck_rhel_major }}-{{ sat_precheck_arch }}
  changed_when: false

- name: Build URL and tmp path
  ansible.builtin.set_fact:
    sat_precheck_kernel_url: >-
      https://{{ sat_precheck_capsule_fqdn }}{{ sat_precheck_kernel_base_path }}/{{ sat_precheck_kernel_file }}
    sat_precheck_tmp_file: >-
      {{ sat_precheck_tmp_dir }}/{{ sat_precheck_kernel_file }}
  changed_when: false

- name: Init result
  ansible.builtin.set_fact:
    sat_precheck:
      capsule: "{{ sat_precheck_capsule_fqdn }}"
      rhel_major: "{{ sat_precheck_rhel_major }}"
      arch: "{{ sat_precheck_arch }}"
      kernel_file: "{{ sat_precheck_kernel_file }}"
      url: "{{ sat_precheck_kernel_url }}"
      tmp_file: "{{ sat_precheck_tmp_file }}"
      port_443_ok: false
      download_ok: false
      http_status: null
      kernel_version: ""
      error: ""
  changed_when: false

- name: Precheck block (443 + download + read + cleanup)
  block:
    - name: Check TCP 443 to capsule
      ansible.builtin.wait_for:
        host: "{{ sat_precheck_capsule_fqdn }}"
        port: 443
        timeout: "{{ sat_precheck_tcp_timeout }}"
        state: started
      register: _tcp443
      failed_when: false
      changed_when: false

    - name: Save 443 status
      ansible.builtin.set_fact:
        sat_precheck: "{{ sat_precheck | combine({'port_443_ok': (_tcp443 is succeeded)}) }}"
      changed_when: false

    - name: Download kernel_version file to /tmp (get_url)
      ansible.builtin.get_url:
        url: "{{ sat_precheck_kernel_url }}"
        dest: "{{ sat_precheck_tmp_file }}"
        mode: "0644"
        validate_certs: "{{ sat_precheck_validate_certs }}"
        timeout: "{{ sat_precheck_https_timeout }}"
      register: _dl
      failed_when: false
      changed_when: false

    - name: Save download status + http status
      ansible.builtin.set_fact:
        sat_precheck: >-
          {{
            sat_precheck | combine({
              'download_ok': (_dl is succeeded),
              'http_status': (_dl.status | default(None)),
              'error': (_dl.msg | default(_dl.stderr | default('')))
            })
          }}
      changed_when: false

    - name: Read downloaded kernel_version file
      ansible.builtin.slurp:
        src: "{{ sat_precheck_tmp_file }}"
      register: _slurp
      when: _dl is succeeded
      changed_when: false

    - name: Extract kernel version content
      ansible.builtin.set_fact:
        sat_precheck: "{{ sat_precheck | combine({'kernel_version': (_slurp.content | b64decode | trim)}) }}"
      when: _dl is succeeded
      changed_when: false

    - name: Fail hard if requested
      ansible.builtin.fail:
        msg: >-
          Precheck KO:
          443_ok={{ sat_precheck.port_443_ok }},
          download_ok={{ sat_precheck.download_ok }},
          http={{ sat_precheck.http_status }},
          err={{ sat_precheck.error }}
      when:
        - sat_precheck_fail_hard | bool
        - (not sat_precheck.port_443_ok) or (not sat_precheck.download_ok)

  rescue:
    - name: Unexpected error during precheck block
      ansible.builtin.set_fact:
        sat_precheck: "{{ sat_precheck | combine({'error': 'Unexpected error during precheck block'}) }}"
      changed_when: false

    - name: Fail hard on exception if requested
      ansible.builtin.fail:
        msg: "Precheck KO (exception): {{ sat_precheck.error }}"
      when: sat_precheck_fail_hard | bool

  always:
    - name: Cleanup /tmp file
      ansible.builtin.file:
        path: "{{ sat_precheck_tmp_file }}"
        state: absent
      changed_when: false

- name: Show final precheck result
  ansible.builtin.debug:
    var: sat_precheck