OK — tu peux l’ajouter dans ton rôle AAP existant sous forme d’un bloc “cleanup RHSM UUID + purge identity” avant la tâche subscription-manager register.
1) Ajoute des variables (defaults)
roles/<ton_role>/defaults/main.yml
Copy code
Yaml
rhsm_cleanup_before_register: true

# Supprime le fact uuid si tu penses qu’il cause des doublons (souvent le cas en clonage)
rhsm_remove_uuid_fact: true

# Purge forte (certs/cache). Recommandé si erreurs “duplicate UUID / aborted”
rhsm_purge_certs_and_cache: true
2) Crée un fichier tasks dédié “cleanup”
roles/<ton_role>/tasks/rhsm_cleanup.yml
Copy code
Yaml
---
- name: RHSM | Unregister (if any)
  command: subscription-manager unregister
  register: _unreg
  failed_when: false
  changed_when: "'Unregister' in (_unreg.stdout | default(''))"

- name: RHSM | Clean local data
  command: subscription-manager clean
  register: _clean
  failed_when: false
  changed_when: true

- name: RHSM | Remove uuid fact file (optional)
  file:
    path: /etc/rhsm/facts/uuid.facts
    state: absent
  when: rhsm_remove_uuid_fact | bool

- name: RHSM | Purge consumer/entitlement certs and cache (optional)
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/pki/consumer
    - /etc/pki/entitlement
    - /var/lib/rhsm
    - /var/cache/rhsm
  when: rhsm_purge_certs_and_cache | bool

- name: RHSM | Recreate dirs after purge (safe)
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - /etc/pki/consumer
    - /etc/pki/entitlement
    - /var/lib/rhsm
    - /var/cache/rhsm
  when: rhsm_purge_certs_and_cache | bool
3) Appelle ce cleanup dans ton tasks/main.yml (avant register)
roles/<ton_role>/tasks/main.yml
Copy code
Yaml
---
- name: RHSM | Cleanup before register (optional)
  import_tasks: rhsm_cleanup.yml
  when: rhsm_cleanup_before_register | bool

# Ensuite ton register existant
- name: RHSM | Register
  command: >
    subscription-manager register
    --activationkey={{ rhsm_activationkey }}
    --org={{ rhsm_org }}
    --force
  register: _reg
  changed_when: "'The system has been registered' in (_reg.stdout | default(''))"
⚠️ Important : évite les quotes cassées dans ta commande. Mets les variables Ansible sans \" ou ' inutiles (c’est exactement ce qui provoque “unexpected EOF while looking for matching”).
4) Variables attendues (exemple)
Dans ton inventory / extra-vars :
Copy code
Yaml
rhsm_org: "BP2I"
rhsm_activationkey: "RHEL9-x86_64-PROD"
Option “propre Satellite” (si tu veux aussi supprimer l’ancien consumer côté Satellite)
Ça se fait plutôt depuis AAP avec un job séparé qui exécute hammer content-host delete (sur le control node), mais c’est un autre bloc.
Si tu me colles ton extrait actuel du rôle (la task subscription-manager register + template jinja si tu l’utilises), je te renvoie le patch exact à appliquer sans casser le reste.