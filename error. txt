Parfait, on voit exactement la ligne fautive dans ton tasks/main.yml ğŸ‘‡
Tu as :
YAML
Copy code
- "{{ (satellite_register_force | default(false)) | ternary('--force', omit) }}"
â¡ï¸ Câ€™est Ã§a qui gÃ©nÃ¨re __omit_place_holder__ et ensuite subscription-manager: error: no such option.
âœ… Correction â€œpropreâ€ Ã  mettre dans TON fichier
1) Ajoute juste avant le task Register (dans le block subscription)
YAML
Copy code
- name: "RHSM | Build register argv (safe)"
  ansible.builtin.set_fact:
    rhsm_register_argv: >-
      {{
        [
          'subscription-manager','register',
          '--activationkey', (satellite_register_ak | trim),
          '--org', (satellite_register_org | trim)
        ]
        + ( ['--force'] if (satellite_register_force | default(false)) else [] )
      }}
2) Remplace ton task Register par celui-ci
YAML
Copy code
- name: "RHSM | Register (safe, NO shell, single call)"
  ansible.builtin.command:
    argv: "{{ rhsm_register_argv }}"
  register: rhsm_register
  changed_when: false
  failed_when: rhsm_register.rc != 0
  timeout: 300
âœ… Et tu supprimes complÃ¨tement la ligne ternary('--force', omit).
âœ… Bonus : corriger aussi le retry dans rhsm_uuid_422_rescue.yml
Dans ton rescue file, fais pareil : ne jamais utiliser omit dans argv.
Pour le retry, le plus simple :
YAML
Copy code
- name: "RHSM | Retry register after KB fix"
  ansible.builtin.command:
    argv: "{{ rhsm_register_argv + ['--force'] }}"
  register: rhsm_register_retry
  changed_when: false
  failed_when: rhsm_register_retry.rc != 0
  timeout: 300
(si rhsm_register_argv nâ€™est pas visible dans ce fichier, reconstruis-le dans le rescue avec le mÃªme set_fact)
RÃ©sultat
plus de __omit_place_holder__
plus de cannot parse argument
plus de no such option
register stable sur des milliers de hosts
Si tu veux je te donne directement le diff complet (bloc subscription entier + include rescue) prÃªt Ã  coller/commit.


Voici le diff complet prÃªt Ã  coller/commit pour corriger dÃ©finitivement le problÃ¨me __omit_place_holder__ (et garder ton rescue 422).
1) roles/satellite_register/tasks/main.yml (bloc subscription complet)
Remplace ton bloc actuel par celui-ci (mÃªmes noms de vars que ta capture) :
YAML
Copy code
- name: subscription
  block:

    - name: "RHSM | Build register argv (safe)"
      ansible.builtin.set_fact:
        rhsm_register_argv: >-
          {{
            [
              'subscription-manager', 'register',
              '--activationkey', (satellite_register_ak | trim),
              '--org', (satellite_register_org | trim)
            ]
            + ( ['--force'] if (satellite_register_force | default(false)) else [] )
          }}

    - name: "RHSM | Register (safe, NO shell, single call)"
      ansible.builtin.command:
        argv: "{{ rhsm_register_argv }}"
      register: rhsm_register
      changed_when: false
      failed_when: rhsm_register.rc != 0
      timeout: 300

  rescue:

    - name: "RHSM | Handle duplicate UUID error (422) via dedicated tasks file"
      ansible.builtin.include_tasks: rhsm_uuid_422_rescue.yml

  always:

    - name: "RHSM | Debug (main + retry)"
      ansible.builtin.debug:
        msg:
          - "MAIN rc={{ rhsm_register.rc | default('N/A') }} stderr={{ rhsm_register.stderr | default('') }}"
          - "LOGICAL_UUID={{ rhsm_logical_uuid | default('N/A') }}"
          - "RETRY rc={{ rhsm_register_retry.rc | default('N/A') }} stderr={{ rhsm_register_retry.stderr | default('') }}"
        verbosity: 1

    - name: "RHSM | Fail clearly if retry still failed (action required)"
      ansible.builtin.fail:
        msg: |
          RHSM registration still failing after applying KB fix (custom dmi.system.uuid + facts cache cleanup).
          - Logical UUID used: {{ rhsm_logical_uuid | default('N/A') }}
          - Initial stderr: {{ rhsm_register.stderr | default('') }}
          - Retry stderr: {{ rhsm_register_retry.stderr | default('') }}

          Next actions:
          1) Check Satellite setting:
             Administer -> Settings -> Content -> 'Host Duplicate DMI UUIDs'
          2) Regenerate BIOS/DMI UUID at hypervisor/provisioning layer (Terraform/VMware template issue).
      when:
        - rhsm_register_retry is defined
        - rhsm_register_retry.rc is defined
        - rhsm_register_retry.rc != 0
âœ… Ce bloc supprime totalement lâ€™usage de omit dans argv.
2) roles/satellite_register/tasks/rhsm_uuid_422_rescue.yml (ajout pour retry sans omit)
Dans ton rhsm_uuid_422_rescue.yml, assure-toi dâ€™avoir aussi un argv propre.
Ajoute (ou remplace) la partie retry avec ceci :
YAML
Copy code
# Rebuild argv here too (safe even if called via include_tasks)
- name: "RHSM | Build register argv (safe) (rescue)"
  ansible.builtin.set_fact:
    rhsm_register_argv: >-
      {{
        [
          'subscription-manager', 'register',
          '--activationkey', (satellite_register_ak | trim),
          '--org', (satellite_register_org | trim)
        ]
      }}

# ... (tes tasks UUID / facts --update etc.)

- name: "RHSM | Retry register after KB fix"
  ansible.builtin.command:
    argv: "{{ rhsm_register_argv + ['--force'] }}"
  register: rhsm_register_retry
  changed_when: false
  failed_when: rhsm_register_retry.rc != 0
  timeout: 300
âœ… Ici on force --force uniquement au retry, sans omit.
3) Petit rappel (UUID facts JSON)
Dans ton rescue, garde bien lâ€™Ã©criture JSON robuste (Ã§a Ã©vite le bug que tu as eu) :
YAML
Copy code
- name: "RHSM | Write /etc/rhsm/facts/uuid.facts"
  ansible.builtin.copy:
    dest: /etc/rhsm/facts/uuid.facts
    owner: root
    group: root
    mode: "0644"
    content: "{{ {'dmi.system.uuid': rhsm_logical_uuid} | to_json }}"
RÃ©sultat attendu aprÃ¨s commit
âœ… Plus jamais de __omit_place_holder__
âœ… Plus de subscription-manager: error: no such option
âœ… Register OK
âœ… Rescue 422 OK
Si tu veux, je peux aussi te donner une version â€œdiff gitâ€ (avec ---/+++), mais le bloc ci-dessus est dÃ©jÃ  prÃªt Ã  copier/coller tel quel.